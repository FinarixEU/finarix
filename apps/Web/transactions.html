<!doctype html><html lang="de"><head>
<meta charset="utf-8"/><title>Transaktionen</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:system-ui;margin:40px}
input,select,button{padding:10px;margin:4px}
table{border-collapse:collapse;width:100%;margin-top:10px}
td,th{border:1px solid #eee;padding:8px}
.right{text-align:right}
pre{background:#f4f4f4;padding:10px}
</style></head><body>
<h2>Konten & Transaktionen</h2>

<div id="guard" hidden>Du bist nicht eingeloggt. <a href="./login.html">Login</a></div>

<div id="app" hidden>
  <div>
    <input id="accName" placeholder="Kontoname"/>
    <input id="accType" placeholder="Typ (bank/cash)"/>
    <button id="createAcc">Konto anlegen</button>
  </div>

  <div>
    <select id="acc"></select>
    <input id="amt" type="number" step="0.01" placeholder="0.00"/>
    <input id="desc" placeholder="Beschreibung"/>
    <button id="add">+ Transaktion</button>
    <button id="reload">Neu laden</button>
    <button id="logout">Logout</button>
  </div>

  <pre id="msg"></pre>

  <table>
    <thead><tr><th>Datum</th><th>Konto</th><th class="right">Betrag</th><th>Text</th></tr></thead>
    <tbody id="rows"><tr><td colspan="4">Lade…</td></tr></tbody>
  </table>

  <p><a href="./index.html">← Zurück</a></p>
</div>

<script src="./js/api.js"></script>
<script>
const guard=document.getElementById('guard'),app=document.getElementById('app');
if(!getToken()){guard.hidden=false;app.hidden=true;}else{guard.hidden=true;app.hidden=false;init();}

const acc=document.getElementById('acc'),amt=document.getElementById('amt'),desc=document.getElementById('desc');
const rows=document.getElementById('rows'),msg=document.getElementById('msg');

async function init(){
 msg.textContent='Konten laden…';
 const a=await api('/accounts',{method:'GET'});
 acc.innerHTML='';
 a.forEach(x=>{
   const o=document.createElement('option');o.value=x.id;o.textContent=x.name;acc.appendChild(o);
 });
 await loadTx();
 msg.textContent='';
}

async function loadTx(){
 rows.innerHTML='<tr><td colspan="4">Lade…</td></tr>';
 const t=await api('/transactions',{method:'GET'});
 if(!t.length){rows.innerHTML='<tr><td colspan="4">Keine Daten</td></tr>';return;}
 rows.innerHTML='';
 t.forEach(x=>{
   const tr=document.createElement('tr');
   tr.innerHTML=`<td>${new Date(x.createdAt).toLocaleString()}</td>
   <td>${x.account?.name||x.accountId}</td>
   <td class="right">${Number(x.amount).toFixed(2)}</td>
   <td>${x.description||''}</td>`;
   rows.appendChild(tr);
 });
}

document.getElementById('createAcc').onclick=async()=>{
 try{
  await api('/accounts',{method:'POST',body:{name:accName.value,type:accType.value||null}});
  accName.value='';accType.value='';
  await init();
 }catch(e){msg.textContent=e.message;}
}

document.getElementById('add').onclick=async()=>{
 try{
  await api('/transactions',{method:'POST',body:{accountId:+acc.value,amount:+amt.value,description:desc.value||null}});
  amt.value='';desc.value='';
  await loadTx();
 }catch(e){msg.textContent=e.message;}
}

document.getElementById('reload').onclick=loadTx;
document.getElementById('logout').onclick=()=>{clearToken();location='./index.html';};
</script>
</body></html>
