<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Konten & Transaktionen – Finarix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:40px}
    input,select,button{padding:8px;margin:6px 6px 6px 0}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border-top:1px solid #eee;padding:10px;text-align:left}
    .muted{color:#666}
  </style>
</head>
<body>
  <h2>Konten & Transaktionen</h2>

  <div>
    <input id="accName" placeholder="Kontoname" />
    <input id="accType" placeholder="Typ (bank/cash)" />
    <button id="btnCreateAcc">Konto anlegen</button>
  </div>

  <div>
    <select id="selAcc"></select>
    <input id="txAmount" type="number" step="0.01" value="0" />
    <input id="txDesc" placeholder="Beschreibung" />
    <button id="btnAddTx">+ Transaktion</button>
    <button id="btnReload">Neu laden</button>
    <button id="btnLogout">Logout</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Konto</th>
        <th>Betrag</th>
        <th>Text</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td class="muted" colspan="4">Lade…</td></tr>
    </tbody>
  </table>

  <p><a href="./index.html">← Zurück</a></p>

  <script src="./js/api.js"></script>
  <script>
    const rows = document.getElementById('rows');
    const selAcc = document.getElementById('selAcc');

    const token = localStorage.getItem('token');
    if (!token) { location.href = './login.html'; }

    function authHeaders() {
      return { Authorization: 'Bearer ' + token };
    }

    async function loadAccounts() {
      const list = await apiRequest('/accounts', { method: 'GET', headers: authHeaders() });
      selAcc.innerHTML = '';
      if (!list.length) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = '— kein Konto —';
        selAcc.appendChild(opt);
      } else {
        for (const a of list) {
          const opt = document.createElement('option');
          opt.value = a.id; opt.textContent = ${a.name} (${a.type}) – Saldo: ${a.balance};
          selAcc.appendChild(opt);
        }
      }
    }

    async function loadTransactions() {
      const list = await apiRequest('/transactions', { method: 'GET', headers: authHeaders() });
      rows.innerHTML = '';
      if (!list.length) {
        rows.innerHTML = '<tr><td class="muted" colspan="4">Keine Transaktionen</td></tr>';
        return;
      }
      for (const t of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(t.date).toLocaleString()}</td>
          <td>${t.account?.name ?? '-'}</td>
          <td>${t.amount}</td>
          <td>${t.description ?? ''}</td>`;
        rows.appendChild(tr);
      }
    }

    // Buttons
    document.getElementById('btnCreateAcc').onclick = async () => {
      const name = document.getElementById('accName').value.trim();
      const type = document.getElementById('accType').value.trim() || 'bank';
      if (!name) { alert('Kontoname fehlt'); return; }
      await apiRequest('/accounts', {
        method: 'POST',
        headers: authHeaders(),
        body: { name, type }
      });
      document.getElementById('accName').value = '';
      await loadAccounts();
    };

    document.getElementById('btnAddTx').onclick = async () => {
      const accountId = Number(selAcc.value);
      const amount = Number(document.getElementById('txAmount').value);
      const description = document.getElementById('txDesc').value.trim();
      if (!accountId) { alert('Bitte ein Konto wählen'); return; }
      if (!amount && amount !== 0) { alert('Betrag fehlt'); return; }
      await apiRequest('/transactions', {
        method: 'POST',
        headers: authHeaders(),
        body: { accountId, amount, description }
      });
      document.getElementById('txAmount').value = '0';
      document.getElementById('txDesc').value = '';
      await loadAccounts();       // saldo aktualisieren (im Select-Text)
      await loadTransactions();   // liste aktualisieren
    };

    document.getElementById('btnReload').onclick = async () => {
      await Promise.all([loadAccounts(), loadTransactions()]);
    };

    document.getElementById('btnLogout').onclick = () => {
      localStorage.removeItem('token');
      location.href = './index.html';
    };

    // initial
    (async () => {
      try {
        await Promise.all([loadAccounts(), loadTransactions()]);
      } catch (e) {
        console.error(e);
        alert(e.message || 'Fehler beim Laden');
      }
    })();
  </script>
</body>
</html>
